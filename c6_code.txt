#include <WiFi.h>
#include <HTTPClient.h>

// --- CONFIGURE YOUR DETAILS HERE ---
const char* ssid = "YOUR_WIFI_SSID";         // Your Wi-Fi Network Name
const char* password = "YOUR_WIFI_PASSWORD"; // Your Wi-Fi Password

// IMPORTANT: Replace with the IP address of the computer running the Python server.
// To find it on Windows, open Command Prompt and type 'ipconfig'.
// To find it on Mac, open Terminal and type 'ifconfig'.
const char* server_ip = "192.168.137.1"; // This IP has been updated for you.
// ------------------------------------

// The full URL that will be requested
String serverName = "http://" + String(server_ip) + ":5000/update?command=tap";

// --- Piezo Sensor Setup ---
// Connect the piezo sensor to pin D4 (which is also A4 on the XIAO) and GND
const int piezoPin = 4;   
int threshold = 150;      // SENSITIVITY: Increase for less sensitivity, decrease for more.

// --- Function Prototypes ---
void connectToWiFi();

void setup() {
  Serial.begin(115200);
  delay(100); // Small delay for serial to initialize
  pinMode(piezoPin, INPUT);
  Serial.println("Impact Detection System Initializing...");

  connectToWiFi();
}

void loop() {
  // Always check if the Wi-Fi connection is still active
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("Wi-Fi connection lost. Reconnecting...");
    connectToWiFi();
  }

  int sensorValue = analogRead(piezoPin);

  // If a significant tap/vibration is detected...
  if (sensorValue > threshold) {
    Serial.print("Impact detected! Sensor value: ");
    Serial.println(sensorValue);

    // ...send the alert to the server.
    HTTPClient http;
    Serial.print("Sending alert to server: ");
    Serial.println(serverName);

    http.begin(serverName); // Specify the target URL
    int httpResponseCode = http.GET(); // Make the HTTP GET request

    if (httpResponseCode > 0) {
      String payload = http.getString();
      Serial.print("Server responded with code: ");
      Serial.println(httpResponseCode);
      Serial.print("Response: ");
      Serial.println(payload);
    } else {
      Serial.print("Error sending request. Code: ");
      Serial.println(httpResponseCode);
    }

    http.end(); // Free up resources

    // A longer debounce delay to prevent sending multiple alerts for a single event
    delay(2000); 
  }

  delay(20); // A small delay to keep the loop from running too fast
}

// --- Helper function to connect to Wi-Fi ---
void connectToWiFi() {
  Serial.print("Connecting to Wi-Fi network: ");
  Serial.println(ssid);
  WiFi.begin(ssid, password);

  int attempt = 0;
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
    attempt++;
    if (attempt > 20) { // Timeout after 10 seconds
        Serial.println("\nFailed to connect. Please check credentials. Retrying...");
        attempt = 0;
        WiFi.begin(ssid, password);
    }
  }

  Serial.println("\nSUCCESS: Wi-Fi Connected!");
  Serial.print("ESP32 IP Address: ");
  Serial.println(WiFi.localIP());
}